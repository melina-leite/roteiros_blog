---
title: "Testes de significância com dados multivariados no R"
author: "Melina de Souza Leite"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
---

```{r setup, echo=FALSE, warning=FALSE, message=F}
library(knitr)
library(skimr)
library(ggplot2)
library(tidyverse)

opts_chunk$set(
  fig.align = "center", fig.show = "hold", fig.height = 4,
  warning = F, message = F, error = F, cache = T
)
options(formatR.arrow = TRUE, width = 90)
```

Esse roteiro é uma introdução sobre algumas maneiras de se testar algumas hipóteses com dados multivariados em R. O roteiro não pretende ser estatisticamente rigoroso, mas principalmente explicar sucintamente algums métodos a partir de exemplos e estimular os leitores a buscar mais informações e fontes de estudo. Aqui eu também assumo que o leitor já tenha familiaridade com testes de hipótese univariados, como teste T e ANOVA, e com o ambiente de programação R.

Segui o Capítulo 4 do livro do Manly & Navarro Alberto 2016, cujos códigos de exemplo estão disponíveis online [nesse site](https://www.researchgate.net/publication/311283141_R_code_and_data_sets). 

Dados multivariados "aparecem" quando coletamos muitas variáveis em um mesma unidade amostral, por exemplo quando tiramos amostras de sangue e medimos diversos parâmetros para formação de um hemograma. Os testes que vamos lidar aqui, dizem respeito a quando temos os dados divididos em grupos, por exemplo, coletas de sangue de homens e mulheres, e queremos testar se há diferenças entre estes grupos considerando as variáveis medidas ao mesmo tempo, ao contrário de uma análise univariada que faríamos os testes separadamente para cada variável.

Não quer dizer que seja totalmente errado fazer teses univariados para cada variável medida, mas essa abordagm tem algumas desvantagem. Uma das principais é que as chances de se afirmar que existe diferença entre os grupos quando não há aumenta com o número de testes feitos, ou seja com o número de variáveis medidas (chamado de erro tipo I). Exitem formas de se contral esse erro, por exemplo utilizando a **correção de bonferroni** para corrigir o nível de significância dos testes, mas estas correções geralmente são muito conservadoras (veremos exemplos a seguir). Outra desvantagem é que com testes univariados perdemos a informação de covariância (ou correlação) entre as variáveis, ou seja, o grau de associação entre as variáveis, que pode ser de grande importância na interpretação dos dados em mãos.

Para dados multivariados, geralmente é preferível condizir um único teste que usa a informação de todas as variáveis juntas. Por exemplo, quando se deseja testar a hipótese de que as médias de todas as variáveis seja a mesma para diferentes grupos (populações), com um resultado significativo demonstrando a evidência de quem as médias diferem em pelo menos UMA variável. 

As principais premissas dos testes de hipótese multivariados são a normalidade multivariada, geralmente, a homogeneidade de variâncias dos dados. Alguns testes são relativamente robustos para estas premissas, mas é sempre bom checa-las (assunto para outro roteiro). 

# Comparando médias entre dois grupos

Aqui, vamos utilizar os dados de sobrevivência de pardais fornecidos em Manly & Navarro (2016)[1] (Tabela 1). Estes dados consistem em 5 medidas corporais de 49 pardais em dois grupos, os que sobreviveram a uma tempestade (21) e os que morreram (28). Não vamos entrar em detalhes sobre a biologia dos dados e partiremos do pressuposto de que os indivíduos foram coletados de maneira indepenente e que nossa hipótese é de que os pardais que sobrevieram possuiam uma morfologia diferente dos que vieram a falecer. 

[1]: Para isso, baixe o material do livro disponível  [nesse site](https://www.researchgate.net/publication/311283141_R_code_and_data_sets). Informações sobre os dados estão disponíveis no próprio livro Capítulo 1.

```{r}
pardais <- read.csv("Bumpus_sparrows.csv",header=TRUE)
```

```{r, echo=F}
kable(pardais[c(1:4,22:25),], caption = "Parte dos dados de medidas corporais de indivíduos de pardais coletados mortos ou vivos (coluna `Survivorship`: S - sobreviveu; NS - não sobreviveu).")
```

## Breve exploração dos dados

A primeira etapa a ser feita é a análise exploratória e descritiva dos dados, por exemplo, tirando estatísticas sumárias dos dados e comparando os indivíduos sobreviventes e não sobreviventes. Não vou me estender nesse assunto, mas uma exploração útil nesse exemplo pode ser fazer boxplots para cada variável de interesse.

```{r, fig.cap="Comparandos as medidas corporais entre os indivíduos que sobreviveram (S) ou não (NS)."}
library(dplyr); library(ggplot2)
#usando os pacotes dplyr para organizar os dados e ggplot2 para plotá-los
pardais %>% gather("variaveis", "valores", 2:6) %>%
  ggplot(aes(x=Survivorship, y=valores)) + 
    geom_boxplot() + 
    facet_wrap(~variaveis, scales="free" ) +
    ylab("Comprimentos (cm)")
```


Olhando cada variável no boxplot, parece não haver muita diferença entre os pardais sobrevivente e não sobreviventes. 

## Verificando premissas do método

### Normalidade Multivariada

### Homogeneidade de variâncias

## Fazendo testes univariados para cada variável

Para comparações com o teste multivariado, vamos fazer primeiro testes T para cada variável do banco de dados. Mesmo que os dados não sejam "tão" normais multivariados ou que tenham variâncias iguais, o teste T é considerado relativamente robusto à estas premissas.

```{r}
t.test(Total_length ~ Survivorship, data = pardais, var.equal = TRUE)
t.test(Alar_extent ~ Survivorship, data = pardais, var.equal = TRUE)
t.test(L_beak.head ~ Survivorship, data = pardais, var.equal = TRUE)
t.test(L_humerous ~ Survivorship, data = pardais, var.equal = TRUE)
t.test(L_keel_sternum ~ Survivorship, data = pardais, var.equal = TRUE)
```


## Comparando as médias de todas as variáveis para sobrevivente e não-sobreviventes

Para essa comparação vamos utilizar o teste T^2^ de Hotelling, que é uma generalização da estatística t.

```{r}
library(Hotelling)  
t2multi <- hotelling.test(Total_length + Alar_extent + L_beak.head + 
                              L_humerous + L_keel_sternum ~ Survivorship, 
                              data=sparrows)
cat("T2 statistic =",t2multi$stat[[1]],"\n",
    "P-value = ", t2multi$pval)
```


