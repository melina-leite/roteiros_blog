---
title: "Testando normalidade multivariada"
author: "Melina de Souza Leite http://melinaleite.weebly.com/"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
bibliography: refs.bib
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
---

```{r setup, echo=FALSE, warning=FALSE, message=F}
#install_github("melina-leite/rmdformats")
library(knitr)
library(ggplot2); library(cowplot); library(patchwork)

opts_chunk$set(
  fig.align = "center", fig.show = "hold",
  warning = F, message = F, error = F, cache = T
)
options(formatR.arrow = TRUE, width = 90)
```

<!---
AINDA PRECISA COLOCAR O LINK PARA O ROTEIRO DE OUTLIERS:
QUANDO FOR PARA O BLOG, COLOCAR ROTEIRO DO BLOG, QUANDO ESTIVER NO RPUBS, ROTEIRO PARA O RPUBS.
--->


Em diversas análises de dados quantitativos multivariados existe a premissa de que a distribuição dos dados segue uma Normal Multiviariada. Outras abordagens, mesmo não exigindo, são beneficiados quando os dados são  multinormalidade  ou pelo menos, não assimétricos (distribuições com caudas longas). Portanto, um passo crucial nas análises é verificar essa premissa.

Abaixo descrevo brevemente algumas formas de se testar e verificar graficamente a normalidade multivariada. Vale a pena ver antes o roteiro de [deteção de outliers]() que irá ajudar a entender melhor os dados, já que muitas vezes a presença de outliers é responsável pela "não-normalidade" dos dados.

Nesse roteiro utilizarei principalmente o pacote [`MVN`](https://pdfs.semanticscholar.org/5508/25b2681f1cc067c66df6ddbd62c74b441869.pdf?_ga=2.25175998.286279602.1517010562-1528935492.1517010562).

# Testando normalidade em cada variável separadamente

Geralmente, a primeira inspeção dos dados é observar gráficos e teses de normalidade para cada variável separadamente. 

Vamos usar os dados `swiss`  do pacote `datasets`[^1].

[^1]: que não precisa ser carregado porque já vem junto como R base.


O primeiro gráfico são os histogramas de frequência de cada variável. As curvas em vermelho indicam uma suposta distribuição normal ao qual os dados se ajustariam.

```{r}
library(MVN)

uniPlot(swiss, "histogram")
```

Boxplots também ajudam a observar a distribuição dos dados e possíveis valores extremos (outliers).
```{r}
uniPlot(swiss, "box")
```

Mas talvez o gráfico mais importante para observar normalidade é o gráfico quantil-quantil (`qqplot`):

```{r}
uniPlot(swiss, "qqplot")
```


No qqplot, variáveis que seguem uma distribuição normal deveriam manter-se sobre a linha reta desenhada no gráfico. 

Com estes gráficos, vemos que a variável `Catholic` está bem distante de uma normal pois tem uma distribuição muito achatada ("kurtosis"), e que `Education` tem uma cauda muito longa tornando a distribuição assimétrica ("skewness").

Agora, vamos olhar os testes de normalidade de [Shapiro-Wilk](https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test), que é um dos mais recomendáveis (@legendre_numerical_2012).
```{r}
uniteste <- uniNorm(swiss)
uniteste$`Shapiro-Wilk's Normality Test`
```

Confirmando as observações gráficas, as duas variáveis identificadas como distantes da distribuição normal são `Catholic` e `Education`. 

Entretanto, mostrar normalidade separadamente em cada variável não garante que haja normalidade multivariada quando consideramos todas as variáveis ao mesmo tempo. Se queremos usar os dados em análises multivariadas, precisamos testar a normalidade multivariada com todas as variáveis conjuntamente.

# Normalidade multivariada

Existem diferentes testes para normalidade multivariada, e aqui vamos analisar 3 destes que são recomendáveis e disponíveis no pacote `MVA`. Para detalhes de como são calculados estes testes veja a [publicação do pacote](https://pdfs.semanticscholar.org/5508/25b2681f1cc067c66df6ddbd62c74b441869.pdf?_ga=2.25175998.286279602.1517010562-1528935492.1517010562).


## Teste de Mardia

É um teste baseado nas extensões multivariadas para assimetria e curtose ("achatamento"). 

Usando a função `mardiaTest`, temos os resultados para a assimetria multivariada (primeiro conjunto de resultados), para a assimetria corrigida para pequeno tamanho amostral (último cojunto de dados) e para o achatamente (curtose). Aparentemente, o que mais "atrapalha" a multinormalidade é a assimetria

```{r}
mardiaTest(swiss, qqplot=T)
```

Nos testes univariados vimos que `Education` era a variável com maior assimetria na distribuição. Se retirarmos esta variável dos dados?

```{r}
mardiaTest(swiss[,-4])
```

Continuamos com assimetria multivariada!!
E se transformarmos estes dados em log? 

```{r}
mardiaTest(cbind(swiss[,-4], log(swiss[,4])))
```

Bom, aparentemente não é só `Education` que está deixando os dados não multinormais. Removendo também `Catholic` vemos que, mesmo apresentando curtose e não assimetria, estas variável estava influenciando bastante no teste de Mardia.

```{r}
mardiaTest(swiss[,-c(4:5)])
```

## Teste de Henze-Zirklers

Este teste está baseado na [distância de Mahalanobis](https://en.wikipedia.org/wiki/Mahalanobis_distance) entre cada observação e o centróide da distribuição e também na distância de Mahalanobis entre as observações (veja [esse roteiro]() para mais detalhes).

```{r}
hzTest(swiss)
```

O resultado deste teste está de acordo com o resultado do teste de Mardia. Vejamos no exemplo em que excluímos as variáveis "problemáticas".

```{r}
hzTest(swiss[,-c(4:5)])
```


## Teste de Royston

O teste de Royston baseia-se na estatística de Shapiro-Wilk[^2] para testar a normalidade multivariada. 

[^2]: ou Shapiro-Francia dependendo do valor de curtose.

```{r}
roystonTest(swiss)
```

```{r}
roystonTest(swiss[,-c(4:5)])
```


# Conclusões

Em nosso exemplo, todos os 3 diferentes testes de normalidade multivariada convergiram em seus resultados, o que significa maior confiança nos resultados. Mas tão importante quanto fazer os testes é fazer o gráfico qqplot para a normalidade multivariada. Nas funções de testes usadas acima, temos a opção de visualização gráfica do qqplot com o argumento `qqplot=TRUE`.

```{r}
#podemos usar qualquer uma das funções de teste para fazer o qqplot
hzTest(swiss, qqplot=T)
```

Observando o plot, podemos supor que possam existir dados extremos que estejam levando à distribuição multivariada não se conformar com a normalidade, portanto, também é importante verificar nos dados os outliers multivariados (veja [este roteiro]()) na tentativa de entender melhor os dados em mãos para fazer melhores escolhas de análises. 


# Referências

